# VaultV2 formal verification

This folder contains the [CVL](https://docs.certora.com/en/latest/docs/cvl/index.html) specification and verification setup for [VaultV2](../src/VaultV2.sol).

## Getting started

This project depends on several [Solidity](https://soliditylang.org/) versions required for running the verification.
The compiler binaries should be available at the paths:

- `solc-0.8.19` for the Solidity compiler version `0.8.19`;
- `solc-0.8.21` for the Solidity compiler version `0.8.21`;
- `solc-0.8.28` for the Solidity compiler version `0.8.28`.

Some verifications run on modified Morpho Vault V1 source files, generated by running:

```
make -C lib/metamorpho/certora munged
```

To verify a specification, run `certoraRun Spec.conf`, where `Spec.conf` is the configuration file for the matching CVL specification.
Configuration files are available in [`certora/confs`](confs).
Please ensure that `CERTORAKEY` is set in your environment.

## Overview

A VaultV2 vault is an ERC4626 vault that allows its users to allocate funds through adapters across a variety of markets and ERC4626 vaults. Those adapters dispatch funds to existing contracts, including—but not limited to—Morpho Markets V1 and Morpho Vaults V1. See [`README.md`](../README.md) for an in-depth description of VaultV2.

### ERC20 tokens and transfers

In [`TokensMorphoMarketV1Adapter.spec`](specs/TokensMorphoMarketV1Adapter.spec) and [`TokensMorphoVaultV1Adapter.spec`](specs/TokensMorphoVaultV1Adapter.spec), the token flow is specified so that tokens are forwarded to Morpho Markets V1 and Morpho Vaults V1, respectively; accordingly, the vault and its adapters should not hold funds when a liquidity adapter is set.
The vault may only hold assets when no liquidity adapter is set, as defined in [`TokensNoAdapter.spec`](specs/TokensNoAdapter.spec).
Similarly, all outgoing tokens are forwarded to the receiver.
When implementing new adapters, it is good practice to define the expected token flow in a dedicated specification file.

This verification assumes that Morpho Markets V1 and Morpho Vaults V1 respect the requirements listed in the Morpho Markets V1 documentation.
In particular, for ERC20 tokens the verification considers three common variants:

- [ERC20Standard](../lib/metamorpho/certora/dispatch/ERC20Standard.sol), which respects the standard and reverts on insufficient funds or allowance;
- [ERC20NoRevert](../lib/metamorpho/certora/dispatch/ERC20NoRevert.sol), which respects the standard but returns `false` instead of reverting;
- [ERC20USDT](../lib/metamorpho/certora/dispatch/ERC20USDT.sol), which omits the return value of `transfer` and `transferFrom`.

### Interactions with other contracts

This section explains how external calls are scoped and checked, ensuring VaultV2’s safety.

#### Reentrancy and immutability

VaultV2 interacts with various contracts, including Morpho Markets V1, Morpho Vaults V1, its adapters, and the assets of the vaults and markets. This is checked in [`Reentrancy.spec`](specs/Reentrancy.spec).
Informally, tokens, Morpho Markets V1, and Morpho Vaults V1 are trusted. The addition of adapters is subject to a timelock mechanism, allowing users (or, by proxy, sentinel users) to ensure new adapters align with the desired risk profile.

Additionally, the contract is verified as immutable in [`Immutability.spec`](specs/Immutability.spec).

### Compliance

The specification file [`Gates.spec`](specs/Gates.spec) defines how gating can restrict moving managed assets via VaultV2 or transferring VaultV2 shares to implement compliance requirements dynamically.

### Liveness

Liveness properties ensure that crucial actions cannot be blocked. This is especially useful to show that, in an emergency, salvaging transactions remain possible.
The rules in [`Liveness.spec`](specs/Liveness.spec) show that it is always possible for the owner to retake control of the vault to deallocate funds or decrease caps. This follows from [`SentinelLiveness.spec`](specs/SentinelLiveness.spec) and [`OwnerSafety.spec`](specs/OwnerSafety.spec) and from the fact that the sentinel can execute those actions.
The owner need only set themselves as curator and sentinel to revoke undesired timelocks and perform safety actions.

### Other safety properties

#### Sanity checks

Additional checks ensure code safety:

- it is checked in [`Invariants.spec`](specs/Invariants.spec) that user-set values are within valid ranges;
- it is checked in [`PreviewFunctions.spec`](specs/PreviewFunctions.spec) that preview functions agree with their stateful counterparts;
- it is checked in [`AbdicatedFunctions.spec`](specs/AbdicatedFunctions.spec) that abdicated functions cannot be changed;
- it is checked that [`MorphoMarketV1AdapterFactory`](specs/MorphoMarketV1AdapterFactory.spec) and
  [`MorphoVaultV1AdapterFactory`](specs/MorphoVaultV1AdapterFactory.spec) deploy adapters only via their factories.

## Folders and file structure

The [`certora/specs`](specs) folder contains the specification files.

The [`certora/confs`](confs) folder contains a configuration file for each corresponding specification file.

The [`certora/helpers`](helpers) folder contains helper contracts used in the verification of VaultV2.
